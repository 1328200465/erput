package xyz.erupt.core.controller;import com.google.gson.Gson;import com.google.gson.JsonObject;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.http.HttpStatus;import org.springframework.web.bind.annotation.*;import xyz.erupt.annotation.fun.DataProxy;import xyz.erupt.annotation.fun.OperationHandler;import xyz.erupt.annotation.sub_erupt.RowOperation;import xyz.erupt.core.annotation.EruptRouter;import xyz.erupt.core.bean.*;import xyz.erupt.core.constant.RestPath;import xyz.erupt.core.exception.EruptNoLegalPowerException;import xyz.erupt.core.service.CoreService;import xyz.erupt.core.util.AnnotationUtil;import xyz.erupt.core.util.DataHandlerUtil;import xyz.erupt.core.util.EruptUtil;import xyz.erupt.core.util.TypeUtil;import xyz.erupt.eruptcommon.util.SpringUtil;import javax.servlet.http.HttpServletResponse;import javax.transaction.Transactional;import java.io.Serializable;import java.util.Collection;import java.util.Map;/** * Erupt 对数据的增删改查 * Created by liyuepeng on 9/28/18. */@RestController@RequestMapping(RestPath.ERUPT_DATA)public class EruptDataController {    @Autowired    private Gson gson;    @PostMapping("/table/{erupt}")    @EruptRouter(authIndex = 2)    @ResponseBody    public Page getEruptData(@PathVariable("erupt") String eruptName, @RequestBody JsonObject searchCondition) {        EruptModel eruptModel = CoreService.getErupt(eruptName);        int pageSize = searchCondition.remove(Page.PAGE_SIZE_STR).getAsInt();        int maxSize = 100;        if (pageSize > maxSize) {            pageSize = maxSize;        }        return this.getEruptData(eruptModel, searchCondition.remove(Page.PAGE_INDEX_STR).getAsInt(), pageSize,                searchCondition.remove(Page.PAGE_SORT_STR).getAsString(), searchCondition, null);    }    private Page getEruptData(EruptModel eruptModel, int pageIndex, int pageSize, String sort, JsonObject searchCondition, String customerCondition) {        if (eruptModel.getErupt().power().query()) {            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                customerCondition = SpringUtil.getBean(proxy).beforeFetch(searchCondition);            }            Page page = AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz())                    .queryList(eruptModel, new Page(pageIndex, pageSize, sort),                            EruptUtil.geneEruptSearchCondition(eruptModel, searchCondition),                            customerCondition);            for (Map<String, Object> map : page.getList()) {                DataHandlerUtil.convertDataToEruptView(eruptModel, map);            }            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).afterFetch(page.getList());            }            return page;        } else {            throw new EruptNoLegalPowerException();        }    }    @GetMapping("/tree/{erupt}")    @ResponseBody    @EruptRouter(authIndex = 2)    public Collection<TreeModel> getEruptTreeData(@PathVariable("erupt") String eruptName) {        EruptModel eruptModel = CoreService.getErupt(eruptName);        if (eruptModel.getErupt().power().query()) {            Collection<TreeModel> collection = AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz()).queryTree(eruptModel);            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).afterFetch(collection);            }            return collection;        } else {            throw new EruptNoLegalPowerException();        }    }    @GetMapping("/{erupt}/{id}")    @ResponseBody    @EruptRouter(authIndex = 1)    public Map<String, Object> getEruptDataById(@PathVariable("erupt") String eruptName, @PathVariable("id") String id) {        EruptModel eruptModel = CoreService.getErupt(eruptName);        if (eruptModel.getErupt().power().edit() || eruptModel.getErupt().power().viewDetails()) {            Object data = AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz()).findDataById(eruptModel, id);            return EruptUtil.generateEruptDataMap(eruptModel, data);        } else {            throw new EruptNoLegalPowerException();        }    }    @PostMapping("/{erupt}")    @ResponseBody    @EruptRouter(authIndex = 1)    public EruptApiModel addEruptData(@PathVariable("erupt") String erupt, @RequestBody JsonObject data) {        EruptModel eruptModel = CoreService.getErupt(erupt);        EruptApiModel eruptApiModel = EruptUtil.validateEruptValue(eruptModel, data);        if (eruptApiModel.getStatus() == EruptApiModel.Status.ERROR) return eruptApiModel;        if (eruptModel.getErupt().power().add()) {            Object obj = gson.fromJson(gson.toJson(data), eruptModel.getClazz());            DataHandlerUtil.clearObjectDefaultValueByJson(obj, data);            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).beforeAdd(obj);            }            AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz()).addData(eruptModel, obj);            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).afterAdd(obj);            }            return EruptApiModel.successApi(null);        } else {            throw new EruptNoLegalPowerException();        }    }    @PutMapping("/{erupt}")    @ResponseBody    @EruptRouter(authIndex = 1)    public EruptApiModel editEruptData(@PathVariable("erupt") String erupt, @RequestBody JsonObject data) {        EruptModel eruptModel = CoreService.getErupt(erupt);        EruptApiModel eruptApiModel = EruptUtil.validateEruptValue(eruptModel, data);        if (eruptApiModel.getStatus() == EruptApiModel.Status.ERROR) return eruptApiModel;        if (eruptModel.getErupt().power().edit()) {            Object obj = this.gson.fromJson(data.toString(), eruptModel.getClazz());            DataHandlerUtil.clearObjectDefaultValueByJson(obj, data);            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).beforeEdit(obj);            }            AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz()).editData(eruptModel, obj);            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).afterEdit(obj);            }            return EruptApiModel.successApi(null);        } else {            throw new EruptNoLegalPowerException();        }    }    @DeleteMapping("/{erupt}/{id}")    @ResponseBody    @EruptRouter(authIndex = 1)    public EruptApiModel deleteEruptData(@PathVariable("erupt") String erupt, @PathVariable("id") Serializable id) {        EruptModel eruptModel = CoreService.getErupt(erupt);        if (eruptModel.getErupt().power().delete()) {            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).beforeDelete(id);            }            AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz()).deleteData(eruptModel, id);            for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {                SpringUtil.getBean(proxy).afterDelete(id);            }            return EruptApiModel.successApi(null);        } else {            throw new EruptNoLegalPowerException();        }    }    //为了事务性考虑所以增加了批量删除功能    @Transactional    @DeleteMapping("/{erupt}")    @ResponseBody    @EruptRouter(authIndex = 1)    public EruptApiModel deleteEruptDataList(@PathVariable("erupt") String erupt, @RequestParam("ids") Serializable[] ids) {        EruptApiModel eruptApiModel = EruptApiModel.successApi(null);        for (Serializable id : ids) {            eruptApiModel = this.deleteEruptData(erupt, id);            if (eruptApiModel.getStatus() == EruptApiModel.Status.ERROR) {                break;            }        }        return eruptApiModel;    }    @PostMapping("/{erupt}/operator/{code}")    @ResponseBody    @EruptRouter(authIndex = 1)    public EruptApiModel execEruptOperator(@PathVariable("erupt") String eruptName, @PathVariable("code") String code,                                           @RequestBody JsonObject body) {        EruptModel eruptModel = CoreService.getErupt(eruptName);        for (RowOperation rowOperation : eruptModel.getErupt().rowOperation()) {            if (code.equals(rowOperation.code())) {                if (rowOperation.eruptClass() != void.class) {                    EruptModel erupt = CoreService.getErupt(rowOperation.eruptClass().getSimpleName());                    EruptApiModel eruptApiModel = EruptUtil.validateEruptValue(erupt, body.getAsJsonObject("param"));                    if (eruptApiModel.getStatus() == EruptApiModel.Status.ERROR) return eruptApiModel;                }                OperationHandler operationHandler = SpringUtil.getBean(rowOperation.operationHandler());                JsonObject param = null;                if (!body.get("param").isJsonNull()) {                    param = body.getAsJsonObject("param");                }                return new EruptApiModel(operationHandler.exec(body.get("data"), param));            }        }        throw new EruptNoLegalPowerException();    }    @GetMapping("/tab/tree/{erupt}/{tabFieldName}")    @ResponseBody    @EruptRouter(authIndex = 3)    public Collection<TreeModel> findTabTree(@PathVariable("erupt") String eruptName, @PathVariable("tabFieldName") String tabFieldName) {        EruptModel eruptModel = CoreService.getErupt(eruptName);        if (eruptModel.getErupt().power().viewDetails() || eruptModel.getErupt().power().edit()) {            return AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz()).findTabTree(eruptModel, tabFieldName);        } else {            throw new EruptNoLegalPowerException();        }    }    // REFERENCE API    @PostMapping("/{erupt}/reference-table/{fieldName}")    @ResponseBody    @EruptRouter(authIndex = 1)    public Page getReferenceTable(@PathVariable("erupt") String eruptName,                                  @PathVariable("fieldName") String fieldName,                                  @RequestBody JsonObject searchCondition) {        EruptModel eruptModel = CoreService.getErupt(eruptName);        if (eruptModel.getErupt().power().edit()) {            int pageIndex = searchCondition.remove(Page.PAGE_INDEX_STR).getAsInt();            int pageSize = searchCondition.remove(Page.PAGE_SIZE_STR).getAsInt();            String sort = searchCondition.remove(Page.PAGE_SORT_STR).getAsString();            EruptFieldModel eruptFieldModel = eruptModel.getEruptFieldMap().get(fieldName);            EruptModel eruptReferenceModel = CoreService.getErupt(eruptFieldModel.getFieldReturnName());            return this.getEruptData(eruptReferenceModel, pageIndex, pageSize, sort, searchCondition,                    AnnotationUtil.switchFilterConditionToStr(eruptFieldModel.getEruptField().edit().filter()));        } else {            throw new EruptNoLegalPowerException();        }    }    @PostMapping("/{parentErupt}/{erupt}/reference-table/{fieldName}")    @ResponseBody    @EruptRouter(authIndex = 1)    public Page getReferenceTableByParentErupt(            @PathVariable("parentErupt") String parentErupt,            @PathVariable("erupt") String eruptName,            @PathVariable("fieldName") String fieldName,            @RequestBody JsonObject searchCondition,            HttpServletResponse response) {        //权限判断        EruptModel parentEruptModel = CoreService.getErupt(parentErupt);        for (EruptFieldModel model : parentEruptModel.getEruptFieldModels()) {            if (model.getFieldReturnName().equals(eruptName)) {                return getReferenceTable(eruptName, fieldName, searchCondition);            }        }        response.setStatus(HttpStatus.FORBIDDEN.value());        return null;    }    @GetMapping("/{erupt}/reference-tree/{fieldName}")    @ResponseBody    @EruptRouter(authIndex = 1)    public Collection<TreeModel> getReferenceTree(@PathVariable("erupt") String erupt,                                                  @PathVariable("fieldName") String fieldName,                                                  @RequestParam(value = "dependValue", required = false) Serializable dependValue) {        EruptModel eruptModel = CoreService.getErupt(erupt);        EruptFieldModel eruptFieldModel = eruptModel.getEruptFieldMap().get(fieldName);        String dependField = eruptFieldModel.getEruptField().edit().referenceTreeType().dependField();        if (!"".equals(dependField)) {            if (null == dependValue) {                throw new RuntimeException("请先选择" + eruptModel.getEruptFieldMap().get(dependField).getEruptField().edit().title());            } else {                //TODO 代码过长，应该做优化                dependValue = TypeUtil.typeStrConvertObject(dependValue,                        CoreService.getErupt(eruptFieldModel.getFieldReturnName()).getEruptFieldMap().get(eruptFieldModel.getEruptField().                                edit().referenceTreeType().dependColumn()).getField().getType().getSimpleName());            }        }        return AnnotationUtil.getEruptDataProcessor(eruptModel.getClazz()).getReferenceTree(eruptModel, fieldName, dependValue);    }    @GetMapping("/{parentErupt}/{erupt}/reference-tree/{fieldName}")    @ResponseBody    @EruptRouter(authIndex = 1)    public Collection<TreeModel> getReferenceTreeByParentErupt(            @PathVariable("parentErupt") String parentErupt,            @PathVariable("erupt") String erupt,            @PathVariable("fieldName") String fieldName,            @RequestParam(value = "dependValue", required = false) Serializable dependValue,            HttpServletResponse response) {        //权限判断        EruptModel parentEruptModel = CoreService.getErupt(parentErupt);        for (EruptFieldModel model : parentEruptModel.getEruptFieldModels()) {            if (model.getFieldReturnName().equals(erupt)) {                return getReferenceTree(erupt, fieldName, dependValue);            }        }        response.setStatus(HttpStatus.FORBIDDEN.value());        return null;    }    @PostMapping("/validate-erupt/{erupt}")    @ResponseBody    @EruptRouter(authIndex = 2)    public EruptApiModel validateErupt(@PathVariable("erupt") String erupt, @RequestBody JsonObject data) {        EruptModel eruptModel = CoreService.getErupt(erupt);        Object obj = gson.fromJson(gson.toJson(data), eruptModel.getClazz());        for (Class<? extends DataProxy> proxy : eruptModel.getErupt().dataProxy()) {            SpringUtil.getBean(proxy).beforeAdd(obj);        }        EruptApiModel eruptApiModel = EruptUtil.validateEruptValue(eruptModel, data);        eruptApiModel.setErrorIntercept(false);        eruptApiModel.setPromptWay(EruptApiModel.PromptWay.MESSAGE);        return eruptApiModel;    }}